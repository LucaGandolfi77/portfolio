<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title data-i18n="page.title">Books ‚Äî Luca Gandolfi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--paper-bg:#f5ead0;--accent:#8b5e34;--muted:#7b5a3c;--glass:rgba(255,255,255,0.6)}
        html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--paper-bg);color:#2b2b2b}
        /* subtle paper texture using SVG data URI */
        body::before{
            content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px), radial-gradient(rgba(0,0,0,0.02) 0.6px, transparent 0.6px);
            background-size:100% 24px, 6px 6px;opacity:0.6;
        }
        .wrap{position:relative;z-index:1;max-width:1000px;margin:36px auto;padding:28px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.55));border-radius:12px;box-shadow:0 10px 30px rgba(16,16,16,0.08)}
        a.back{display:inline-flex;align-items:center;gap:8px;color:var(--accent);text-decoration:none;margin-bottom:12px;font-weight:600}
        h1{margin:6px 0 10px;font-size:2rem;color:var(--accent)}
        p.lead{margin-bottom:18px;color:var(--muted)}

        /* Accordion */
        .accordion{display:grid;gap:12px}
        .acc-item{border-radius:10px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.85)}
        .acc-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;cursor:pointer}
        .acc-header button{all:unset;display:flex;align-items:center;gap:12px;width:100%;cursor:pointer}
        .acc-title{font-weight:700;color:#3a2b22}
        .acc-preview{color:#6b5b4a;font-size:0.95rem}
        .caret{transition:transform 0.25s ease;color:#7a5a3b}
        .acc-content{padding:0 16px;max-height:0;overflow:hidden;transition:max-height 0.35s ease;padding-bottom:0}
        .acc-content.open{padding:12px 16px 18px}
        .book-list{display:grid;gap:8px}
        .book-item{padding:8px;border-radius:8px;background:rgba(0,0,0,0.02);border:1px solid rgba(0,0,0,0.03)}

        /* small screens */
        @media (max-width:640px){.wrap{margin:18px;padding:18px}.acc-header{padding:12px}.acc-content.open{padding:10px 12px 14px}}

        /* Top-left language selector (consistent with main site) */
        .lang-top-left { position: fixed; top: 12px; left: 12px; z-index: 1002; }
        .lang-top-left select { background: transparent; border: none; color: #2b2b2b; font-weight: 600; cursor: pointer; font-size: 0.95rem; padding: 6px 8px; border-radius:6px; }

    /* Quick nav style */
    .quick-nav { position: fixed; top: 56px; left: 12px; z-index: 1002; display:flex; gap:8px; background: rgba(255,255,255,0.9); padding:6px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    .quick-nav .nav-link { display:inline-flex; align-items:center; gap:8px; padding:6px 8px; color:#2b2b2b; text-decoration:none; border-radius:8px; transition:background 0.15s ease, transform 0.12s ease; font-weight:600 }
    .quick-nav .nav-link .icon{ font-size:1rem }
    .quick-nav .nav-link:hover { background: rgba(0,0,0,0.04); transform: translateY(-2px); }

        /* Books table styles */
        .books-table-wrap { margin-top: 8px; }
        .books-controls { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
        .books-search { flex:1; min-width:200px; padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); font-weight:600 }
        .books-table { width:100%; border-collapse:collapse; background:rgba(255,255,255,0.92); border-radius:12px; overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,0.08); }
        .books-table thead { background:linear-gradient(90deg,#f0f6fb,#e8f3ff); color:#1b3a57; }
        .books-table th, .books-table td { padding:12px 14px; text-align:left; font-size:0.95rem; border-bottom:1px solid rgba(0,0,0,0.06); }
        .books-table th { user-select:none; font-weight:700; cursor:pointer; position:relative; padding-right:24px; }
        .books-table th:hover { background:linear-gradient(90deg,#e8f3ff,#d4e8ff); }
        .books-table th::after { content:''; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:0; height:0; border-left:4px solid transparent; border-right:4px solid transparent; border-top:5px solid #1b3a57; opacity:0; transition:opacity 0.2s ease; }
        .books-table th.sort-asc::after { opacity:1; }
        .books-table th.sort-desc::after { opacity:1; transform:translateY(-50%) rotateZ(180deg); }
        .books-table tbody tr:nth-child(even) td { background: rgba(0,0,0,0.01); }
        .books-table tbody tr:hover td { background: linear-gradient(90deg, rgba(0,212,255,0.04), rgba(0,212,255,0.02)); }
        .books-badge { display:inline-block; padding:6px 8px; border-radius:6px; font-weight:700; font-size:0.85rem; background:white; color:#3a2b22; border:1px solid rgba(0,0,0,0.08); white-space:nowrap; }
        @media (max-width:700px) {
            .quick-nav { display:none; }
            .books-table th:nth-child(3), .books-table td:nth-child(3) { display:none; }
        }
    </style>
</head>
<body>
    <div class="lang-top-left">
        <label for="langSelect" class="visually-hidden">Select language</label>
        <select id="langSelect" aria-label="Select language" title="Change language">
            <option value="en">üá¨üáß EN</option>
            <option value="it">üáÆüáπ IT</option>
            <option value="fr">üá´üá∑ FR</option>
            <option value="es">üá™üá∏ ES</option>
            <option value="zh">üá®üá≥ ‰∏≠</option>
            <option value="ru">üá∑üá∫ RU</option>
            <option value="de">üá©üá™ DE</option>
            <option value="ja">üáØüáµ Êó•Êú¨</option>
            <option value="sv">üá∏üá™ SV</option>
            <option value="ar">üá∏üá¶ AR</option>
            <option value="he">üáÆüá± HE</option>
        </select>
    </div>

    <!-- Quick navigation (links to main portfolio sections) -->
    <nav class="quick-nav" aria-label="Quick navigation">
        <a class="nav-link" href="index.html#about"><span class="icon">üë§</span> <span data-i18n="nav.about">About</span></a>
        <a class="nav-link" href="index.html#skills"><span class="icon">‚ö°</span> <span data-i18n="nav.skills">Skills</span></a>
        <a class="nav-link" href="index.html#experience"><span class="icon">üíº</span> <span data-i18n="nav.experience">Experience</span></a>
        <a class="nav-link" href="index.html#projects"><span class="icon">üß©</span> <span data-i18n="nav.projects">Projects</span></a>
        <a class="nav-link" href="index.html#contact"><span class="icon">‚úâÔ∏è</span> <span data-i18n="nav.contact">Contact</span></a>
    </nav>

    <div class="wrap" role="main">
        <a class="back" href="index.html">‚Üê <span data-i18n="page.back">Back to portfolio</span></a>
        <h1 data-i18n="page.heading">Books</h1>
        <p class="lead" data-i18n="page.lead">Here are a few books I recommend ‚Äî short notes and links.</p>

        <div class="accordion" id="accordion">
            <!-- items populated by JS -->
        </div>

        <footer style="margin-top:20px;color:#6b5a4a;font-size:0.9rem">¬© 2025 Luca Gandolfi</footer>
    </div>

    <script>
        // Load translations from external JSON at /i18n/<lang>.json; fallback uses English if unavailable
        async function loadTranslations(lang) {
            try {
                const res = await fetch('/i18n/' + lang + '.json');
                if (!res.ok) throw new Error('non-ok');
                return await res.json();
            } catch (err) {
                console.warn('Failed to load external translations for', lang, err);
                // fallback to english bundle that should exist
                try {
                    const res2 = await fetch('/i18n/en.json');
                    if (res2.ok) return await res2.json();
                } catch (e) {}
                return {};
            }
        }

        // detect language preference from localStorage (same key used in index.html)
        const savedLang = localStorage.getItem('lang') || 'en';

        function getNested(obj, path){
            return path.split('.').reduce((o,k)=> (o && o[k]!==undefined)? o[k]: undefined, obj);
        }

        function buildAccordion(t){
            const acc = document.getElementById('accordion');
            acc.innerHTML = '';
            const sections = (t && t.books && t.books.sections) ? t.books.sections : {};
            for(const key of ['read','recommended','quotes','life']){
                const s = sections[key] || { title: key, preview: '', items: [] };
                const item = document.createElement('div');
                item.className = 'acc-item';
                    // For 'read' we prefer to show the CSV-powered searchable table when available
                    if (key === 'read') {
                        item.innerHTML = `
                        <div class="acc-header">
                            <button aria-expanded="false" class="acc-btn">
                                <div style="display:flex;flex-direction:column;align-items:flex-start">
                                    <div class="acc-title">${s.title}</div>
                                    <div class="acc-preview">${s.preview}</div>
                                </div>
                                <div class="caret">‚ñ∏</div>
                            </button>
                        </div>
                        <div class="acc-content" aria-hidden="true">
                            <div class="book-list">
                                <div class="books-table-wrap">
                                    <div class="books-controls">
                                        <input class="books-search" placeholder="Search books (title, author, year)..." aria-label="Search books">
                                        <div class="books-count" style="font-weight:600;color:#3a3a3a;white-space:nowrap"></div>
                                    </div>
                                    <div class="book-table-container"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    } else {
                        item.innerHTML = `
                        <div class="acc-header">
                            <button aria-expanded="false" class="acc-btn">
                                <div style="display:flex;flex-direction:column;align-items:flex-start">
                                    <div class="acc-title">${s.title}</div>
                                    <div class="acc-preview">${s.preview}</div>
                                </div>
                                <div class="caret">‚ñ∏</div>
                            </button>
                        </div>
                        <div class="acc-content" aria-hidden="true">
                            <div class="book-list">
                                ${s.items.map(i=>`<div class="book-item">${i}</div>`).join('')}
                            </div>
                        </div>
                    `;
                    }
                // wire toggle
                const btn = item.querySelector('.acc-btn');
                const content = item.querySelector('.acc-content');
                const caret = item.querySelector('.caret');
                btn.addEventListener('click', ()=> toggle(item, btn, content, caret));
                btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggle(item, btn, content, caret); } });
                acc.appendChild(item);

                // If this is the read section, populate the table (if CSV present) and wire search and sort
                if (key === 'read') {
                    const container = item.querySelector('.book-table-container');
                    const searchInput = item.querySelector('.books-search');
                    const countEl = item.querySelector('.books-count');
                    const books = (window.csvBooks && window.csvBooks.length>0) ? window.csvBooks : (s.items||[]).map(title=>({ title }));
                    
                    // State for this section
                    let currentSort = 'title';
                    let currentSortDir = 'asc';
                    
                    // Helper function to update display based on current sort
                    const updateDisplay = () => {
                        const q = (searchInput ? searchInput.value.trim().toLowerCase() : '');
                        const onSortChange = (newSort, newDir) => {
                            currentSort = newSort;
                            currentSortDir = newDir;
                            updateDisplay();
                        };
                        populateBooksTable(container, books, countEl, q, currentSort, currentSortDir, onSortChange);
                        
                        // Update header visual indicators
                        container.querySelectorAll('th[data-sort]').forEach(th => {
                            th.classList.remove('sort-asc', 'sort-desc');
                            if (th.getAttribute('data-sort') === currentSort) {
                                th.classList.add(currentSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
                            }
                        });
                    };
                    
                    // Initial display
                    updateDisplay();
                    
                    // Wire search input
                    if (searchInput) {
                        searchInput.addEventListener('input', updateDisplay);
                    }
                }
            }
        }

        function toggle(item, btn, content, caret){
            const isOpen = btn.getAttribute('aria-expanded') === 'true';
            if(isOpen){
                btn.setAttribute('aria-expanded','false');
                content.style.maxHeight = '0';
                content.setAttribute('aria-hidden','true');
                content.classList.remove('open');
                caret.style.transform = '';
            } else {
                // close any other open
                document.querySelectorAll('.acc-item .acc-btn[aria-expanded="true"]').forEach(otherBtn=>{
                    otherBtn.setAttribute('aria-expanded','false');
                    const otherContent = otherBtn.closest('.acc-item').querySelector('.acc-content');
                    otherContent.style.maxHeight = '0';
                    otherContent.setAttribute('aria-hidden','true');
                    otherContent.classList.remove('open');
                    otherBtn.closest('.acc-item').querySelector('.caret').style.transform = '';
                });

                btn.setAttribute('aria-expanded','true');
                content.classList.add('open');
                content.style.maxHeight = content.scrollHeight + 'px';
                content.setAttribute('aria-hidden','false');
                caret.style.transform = 'rotate(90deg)';
            }
        }

        // apply page-level translations using loaded translation object `t`
        function applyPageTranslations(t){
            if(!t) return;
            document.querySelectorAll('[data-i18n]').forEach(el=>{
                const key = el.getAttribute('data-i18n');
                // prefer direct path, else try under books.* (books page translations are nested)
                let val = getNested(t, key);
                if (val === undefined) val = getNested(t, 'books.' + key);
                if (val !== undefined) el.textContent = val;
            });
            document.title = getNested(t, 'books.page.title') || document.title;
        }

        document.addEventListener('DOMContentLoaded', async ()=>{
            const t = await loadTranslations(savedLang);
            // load CSV of read books first, then apply translations and build UI
            try { await loadCSV(); } catch (e) { console.warn('CSV load failed', e); }
            applyPageTranslations(t);
            buildAccordion(t);
        });

        // Load and parse CSV '/old_books.csv'
        async function loadCSV() {
            try {
                const res = await fetch('/old_books.csv');
                if (!res.ok) throw new Error('fetch failed');
                const txt = await res.text();
                window.csvBooks = parseCSV(txt);
            } catch (err) {
                console.warn('Could not load old_books.csv', err);
                window.csvBooks = [];
                throw err;
            }
        }

        // Very small CSV parser tailored to the file format (comma separated, header present)
        function parseCSV(text){
            const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
            if(lines.length === 0) return [];
            // first line header maybe italian
            const header = lines[0].split(',').map(h=>h.trim());
            const rows = [];
            for(let i=1;i<lines.length;i++){
                const cols = lines[i].split(',').map(c=>c.trim());
                // map by position to known columns: Titolo,Autore,ISBN,Year,Stelle,Cuori,Lacrime
                const obj = {
                    title: cols[0] || '',
                    author: cols[1] || '',
                    isbn: cols[2] || '',
                    year: cols[3] || '',
                    stars: cols[4] || '',
                    hearts: cols[5] || '',
                    tears: cols[6] || ''
                };
                // skip empty title rows
                if(obj.title && obj.title.toLowerCase() !== 'titolo') rows.push(obj);
            }
            return rows;
        }

            // Populate a container with a table of books; optional query for filtering; optional sort ('title', 'author', 'year', 'stars', 'hearts', or 'tears')
            function populateBooksTable(container, books, countEl, query, sort, sortDir, onSortChange) {
                if(!container) return;
                query = (query||'').toLowerCase();
                sort = sort || 'title';
                sortDir = sortDir || 'asc';
                let filtered = books.filter(b=>{
                    if(!b) return false;
                    const hay = ((b.title||'') + ' ' + (b.author||'') + ' ' + (b.year||'')).toLowerCase();
                    return !query || hay.indexOf(query) !== -1;
                });

                // Apply sorting
                if (sort === 'title') {
                    filtered.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                } else if (sort === 'author') {
                    filtered.sort((a, b) => (a.author || '').localeCompare(b.author || ''));
                } else if (sort === 'year') {
                    filtered.sort((a, b) => parseInt(a.year || 0) - parseInt(b.year || 0));
                } else if (sort === 'stars') {
                    filtered.sort((a, b) => parseInt(b.stars || 0) - parseInt(a.stars || 0));
                } else if (sort === 'hearts') {
                    filtered.sort((a, b) => parseInt(b.hearts || 0) - parseInt(a.hearts || 0));
                } else if (sort === 'tears') {
                    filtered.sort((a, b) => parseInt(b.tears || 0) - parseInt(a.tears || 0));
                }
                
                // Apply sort direction
                if (sortDir === 'desc') filtered.reverse();

                countEl && (countEl.textContent = filtered.length + ' results');

                if(filtered.length === 0){
                    container.innerHTML = '<div style="padding:12px;color:#666">No books found.</div>';
                    return;
                }

                // build table HTML
                const rowsHtml = filtered.map(b=>{
                    const stars = b.stars ? `<span class="books-badge">‚≠ê ${b.stars}</span>` : '-';
                    const hearts = b.hearts || '-';
                    const tears = b.tears || '-';
                    return `<tr>
                        <td>${escapeHtml(b.title)}</td>
                        <td>${escapeHtml(b.author)}</td>
                        <td>${escapeHtml(b.year)}</td>
                        <td>${stars}</td>
                        <td style="text-align:center">‚ù§Ô∏è ${hearts}</td>
                        <td style="text-align:center">üò≠ ${tears}</td>
                    </tr>`;
                }).join('');

                container.innerHTML = `
                    <table class="books-table" role="table">
                        <thead>
                            <tr>
                                <th data-sort="title">Title</th>
                                <th data-sort="author">Author</th>
                                <th data-sort="year">Year</th>
                                <th data-sort="stars">Rating</th>
                                <th data-sort="hearts">Hearts</th>
                                <th data-sort="tears">Tears</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                `;
                
                // Wire up header click handlers for sorting
                container.querySelectorAll('th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        const newSort = th.getAttribute('data-sort');
                        let newDir = 'asc';
                        if (sort === newSort && sortDir === 'asc') {
                            newDir = 'desc';
                        }
                        if (onSortChange) {
                            onSortChange(newSort, newDir);
                        }
                    });
                });
            }

            function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // Wire language selector on this page (persist to localStorage and re-apply translations)
        const langSelect = document.getElementById('langSelect');
        if (langSelect) {
            langSelect.value = savedLang;
            langSelect.addEventListener('change', async (e) => {
                const v = e.target.value || 'en';
                localStorage.setItem('lang', v);
                const t = await loadTranslations(v);
                applyPageTranslations(t);
                buildAccordion(t);
            });
        }
    </script>
</body>
</html>
